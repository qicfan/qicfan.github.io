---
layout: post
title: php队列的构思
tags:
- fastcgi_finish_request
- php
- php队列
- queue
- 技术杂谈
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  views: '382'
---
周末突然来的一个构思，基于php-fpm提供的fastcgi_finish_request函数，可以实现一个PHP的处理队列，大致思路如下：

<a href="http://zeroq.me/p/424/php_queue" rel="attachment wp-att-427"><img class="alignnone size-full wp-image-427" title="php_queue" src="http://zeroq.me/wp-content/uploads/2012/04/php_queue.png" alt="" width="494" height="359" /></a>

主要就是在一个PHP请求的前半部分调用封装好的Queue中的push方法，将要处理的数据入队列；
然后判断是否有处理进程正在执行（是否有锁），如果有则直接退出（exit)；
如果没有处理进程，则执行fastcgi_finish_request方法，将请求返回，但是进程将继续执行后续代码。
后续代码作为worker进程首先加锁，然后进入循环，读取队列数据，并且处理，直到队列中无数据，然后退出。

这样就可以实现一个异步的请求队列，这个模型适用于单业务中需要队列保证一致性和处理性能的场景，当然需要一个外部存储方案比如redis，下面是一个大致的例子：
<pre class="brush:[php]">require_once "Queue.php";
$queue = new Queue('test_queue');
$queue-&gt;push($_POST);
if ($queue-&gt;isLock()) {
    exit();
}
fastcgi_finish_request();
$queue-&gt;lock();
while (!$queue-&gt;isEof()) {
    you_do($queue-&gt;pop());
}

function you_do($data) {
    // do_something
}</pre>
