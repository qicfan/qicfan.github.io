---
layout: post
title: mongodb在php中的使用学习
tags:
- mongodb
- php
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  views: '361'
---
最近一直在看mongodb的相关内容，下午无事的时候就准备看看是否可以将mongodb用在文章的评论中，所以就在本地搭建了一下测试环境，先进性一些简单的测试，看看在php中的用法

安装启动好mongodb，然后安装好php_mongo扩展，具体参见：<a href="http://cn.php.net/mongo">http://cn.php.net/mongo</a>
<pre class="brush:[php]">$m = new Mongo("10.69.10.100");
$db = $m-&gt;comment;
$key = md5("17954");
$col = $db-&gt;$key;
$comment = array('author'=&gt;'zeroq', 'timeline'=&gt;1232312123, 'type'=&gt;'Article', 'content'=&gt;'Hello World', 'body_id'=&gt;17954, 'body_title'=&gt;'这是一篇文章');
$col-&gt;insert($comment);
$cursor = $col-&gt;findOne();
print $cursor;</pre>
运行后抛出异常：
PHP Fatal error: Uncaught exception 'MongoException' with message 'non-utf8 string: 这是一篇文章' in D:\www\test.php:7
Stack trace:
#0 D:\www\test.php(7): MongoCollection-&gt;insert(Array)
#1 {main}
thrown in D:\www\test.php on line 7
经过GOOGLE之后发现，这是因为在mangodb中所有的字符串必须是UTF8编码，然后将文件编码转换成UTF-8之后，执行通过。。
简单的代码演示了mongodb的增、改、查（删除很容易）:
<pre class="brush:[php]">$m = new Mongo("10.69.10.100");
$db = $m---&gt;comment;
//print_r($db);exit();
$key = md5("17954");
$col = $db-&gt;$key;
//$col-&gt;remove();exit();
//$comment = array('author'=&gt;'zeroq', 'timeline'=&gt;time(), 'type'=&gt;'Article', 'content'=&gt;'Hello World again', 'body_id'=&gt;17954, 'body_title'=&gt;'这是一篇文章', 'status'=&gt;0);
//$col-&gt;insert($comment);
$cursor = $col-&gt;find(array("tag"=&gt;"17954"));
$cursor-&gt;sort(array('timeline'=&gt;-1));
$cursor-&gt;limit(2);
foreach ($cursor as $item) {
	//$item['tag'] = array('文章', '评论', '17954');
	//$col-&gt;save($item);
	print_r($item);
}</pre>
刚刚又看了下评论的功能，觉得用mongodb还是比较合适的，将每个文章的评论作为一个集合，每个评论是一个文档，用文章ID的MD5值做为collection的名字。
每个IP针对每一篇文章，在1分钟内只能发表一次，这个记录可以放在memcache中，设置1分钟到期
这样完全摒弃了数据库的低效，在效率上应该会高不少
最起码每个文章的评论集合之间现在没啥关系，不会出现无谓的全表检索
最主要的是方便了对象操作

&nbsp;
