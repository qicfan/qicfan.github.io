---
layout: post
title: "dubbo的php客户端实现思路"
description: "dubbo的php客户端实现思路"
category: php
tags: [php,java,dubbo,hessian]
---
{% include JB/setup %}

# Dubbo for PHP开发思路

@(qicfan 的笔记本)[架构|开发]

### 简介-摘自[Dubbo用户指南](http://alibaba.github.io/dubbo-doc-static/User+Guide-zh.htm#UserGuide-zh-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85)

#### 节点角色说明：
- **Provider**: 暴露服务的服务提供方。
- **Consumer**: 调用远程服务的服务消费方。
- **Registry**: 服务注册与发现的注册中心。
- **Monitor**: 统计服务的调用次调和调用时间的监控中心。
- **Container**: 服务运行容器。

#### 调用关系说明：
1. 服务容器负责启动，加载，运行服务提供者。
2. 服务提供者在启动时，向注册中心注册自己提供的服务。
3. 服务消费者在启动时，向注册中心订阅自己所需的服务。
4. 注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。
5. 服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。
6. 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

#### 连通性：
- 注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小
- 监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示
- 服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销
- 服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销
- 注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外
- 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者
- 注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表
- 注册中心和监控中心都是可选的，服务消费者可以直连服务提供者

#### 健状性：
- 监控中心宕掉不影响使用，只是丢失部分采样数据
- 数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务
- 注册中心对等集群，任意一台宕掉后，将自动切换到另一台
- 注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯
- 服务提供者无状态，任意一台宕掉后，不影响使用
- 服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

#### 伸缩性：
- 注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心
- 服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者


### 技术依赖
1. 基于`zookeeper`
2. `注册中心`需要于消费者和提供者保持`长连接`来推送事件
3. 目前全部使用`hessian`协议

### PHP实现思路
1. 需要开发一个单独的服务(简称`proxy`)来跟`注册中心`、`监控中心`通讯
2. 因为咱们的PHP都是基于`factcgi`提供服务的，所以现有的PHP项目没有办法直接使用`dubbo`，所以才需要一个`proxy`的服务
3. `proxy`可以使用`php`或者其他语言实现，但是要保持跟`php`灵活交互，建议依然使用`php`实现，`php`有`zookeeper`的扩展
4. 其他php项目需要到`proxy`添加对应的配置来标记自己是一个`提供者`或者是`消费者`或者是两者
5. `消费者`需要到`proxy`配置自己要订阅的`服务`
6. `proxy`会根据配置更新`消费者`订阅的服务的`提供者列表`
7. `提供者`和`消费者`将调用和服务数据记录到日志中，`proxy`定时扫描日志，将统计数据发送给`监控中心`
8. `消费者`对`提供者`接口的调用由另外的`消费者工具库`实现
9. `提供者`暴漏的服务由`hessian库`实现，由`proxy`向`注册中心`注册

### 开发点以及难点
1. php中`zookeeper`的使用，以及`dubbo`的`zookeeper`的结构
2. 一个`proxy`如何能注册多个`消费者`或者`提供者`
3. 对`hessian`协议的再封装
4. `php项目`于`proxy`的`通讯`，目前倾向使用`配置文件`、可选项有`redis`
5. `dubbo`的`url`的解析
6. 实现`dubbo`的`负载均衡`算法
